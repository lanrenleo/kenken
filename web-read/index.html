<script>
    const { createApp, ref, onMounted } = Vue;

    createApp({
        setup() {
            // === 配置项 ===
            const ENV_ID = 'cloud1-4gcnkqkl8e5bcae5';
            const PARENT_LOCK_PIN = '3721';
            const CATEGORY_MAP = [
                { key: 'beginner', name: '初章' }, { key: 'intermediate', name: '中章' }, { key: 'advanced', name: '高章' },
                { key: 'teen', name: '青少' }, { key: 'adult', name: '成人' }, { key: 'literature', name: '文学' },
                { key: 'tvshow', name: '美剧' }, { key: 'other', name: '其他' }
            ];
            
            // === 状态变量 ===
            const db = ref(null);
            const currentUser = ref(null);
            const loginCode = ref('');
            const filteredBookList = ref([]);
            const currentCategory = ref('beginner');
            const loading = ref(true);
            const keyword = ref('');
            const activeTag = ref(null);
            const isKidMode = ref(true);
            const showPinModal = ref(false);
            const inputPin = ref('');
            
            // === 1. 加载 SDK ===
            const loadSdkScript = () => {
                return new Promise((resolve, reject) => {
                    if (window.cloudbase) return resolve(window.cloudbase);
                    const script = document.createElement('script');
                    // 使用官方最新版
                    script.src = "https://static.cloudbase.net/cloudbase-js-sdk/2.9.1/cloudbase.full.js";
                    script.onload = () => { console.log("SDK loaded"); resolve(window.cloudbase); };
                    script.onerror = () => reject(new Error("SDK load failed"));
                    document.head.appendChild(script);
                });
            };

            // === 2. 初始化云开发（暴力修复版） ===
            const initCloud = async () => {
                try {
                    loading.value = true;
                    
                    // 【核心修复】为了防止旧缓存导致的死循环，先清空本地存储
                    // 只要网页能正常运行一次，以后这行可以注释掉
                    // 但现在调试阶段，请务必保留！
                    if (!window.hasCleaned) {
                        localStorage.clear(); 
                        window.hasCleaned = true;
                        console.log("已强制清理旧缓存");
                    }

                    const cloudbase = await loadSdkScript();

                    const app = cloudbase.init({
                        env: ENV_ID,
                        region: 'ap-shanghai' // 显式指定上海地域
                    });

                    const auth = app.auth({ persistence: 'local' });
                    
                    // 【强制登出再登录】确保凭证是最新生成的
                    await auth.signOut(); 
                    console.log("正在尝试新的匿名登录...");
                    
                    await auth.signInAnonymously();
                    console.log("匿名登录成功！权限已获取。");

                    // 连接数据库
                    db.value = app.database();
                    console.log("数据库连接成功");

                    // 恢复用户偏好（因为刚才clear了，需要重新判断）
                    // 这里简化处理，登录成功后直接加载数据
                    await loadBooks();

                } catch (e) {
                    console.error("Cloud Init Error:", e);
                    // 解析错误对象
                    const errCode = e.error || e.code || 'unknown';
                    const errMsg = e.message || e.error_description || JSON.stringify(e);
                    
                    loading.value = false;
                    alert(`连接失败: [${errCode}] ${errMsg}\n请检查云开发控制台 [设置->登录授权] 中的 [匿名登录] 是否开启。`);
                }
            };

            // === 业务逻辑 ===
            const loadBooks = async () => {
                if(!db.value) return;
                loading.value = true;
                try {
                    const _ = db.value.command;
                    let query = db.value.collection('books').where({ category: currentCategory.value });
                    
                    if (keyword.value) query = query.where({ title: new db.value.RegExp({ regexp: keyword.value, options: 'i' }) });
                    if (activeTag.value) query = query.where({ tags: activeTag.value });
                    if (isKidMode.value) query = query.where({ isAdult: _.neq(true) });

                    const res = await query.limit(50).orderBy('createTime', 'desc').get();
                    
                    const books = res.data.map(b => {
                        // 因为刚才清了缓存，currentUser可能为空，做个防御
                        const perms = (currentUser.value && currentUser.value.permissions) || [];
                        const isUnlocked = perms.includes(b._id) || perms.includes('CATEGORY_' + currentCategory.value);
                        return { ...b, isUnlocked };
                    });
                    
                    books.sort((a, b) => (b.isUnlocked ? 1 : 0) - (a.isUnlocked ? 1 : 0));
                    filteredBookList.value = books;
                } catch (err) {
                    console.error("Load Books Error:", err);
                } finally {
                    loading.value = false;
                }
            };

            const handleLogin = async () => {
                if (!loginCode.value) return alert('请输入激活码');
                if (!db.value) return alert('服务连接中，请稍后再试');
                try {
                    const res = await db.value.collection('students').where({ code: loginCode.value }).get();
                    if (res.data.length > 0) {
                        currentUser.value = res.data[0];
                        // 重新写入缓存
                        localStorage.setItem('web_user', JSON.stringify(res.data[0]));
                        loadBooks();
                    } else {
                        alert('激活码无效');
                    }
                } catch (e) {
                    console.error(e);
                    alert('验证失败');
                }
            };

            const logout = () => {
                if(confirm('确定退出？')) {
                    localStorage.removeItem('web_user');
                    currentUser.value = null;
                    loginCode.value = '';
                }
            };

            const switchCategory = (cat) => { if (currentCategory.value !== cat) { currentCategory.value = cat; loadBooks(); } };
            const onSearchInput = () => { setTimeout(() => { loadBooks(); }, 500); };
            const onTagTap = (tag) => { activeTag.value = tag; keyword.value = ''; loadBooks(); };
            const clearTagFilter = () => { activeTag.value = null; loadBooks(); };
            
            const toggleKidMode = () => {
                if (!isKidMode.value) {
                    isKidMode.value = true;
                    localStorage.setItem('PREF_IS_KID_MODE', 'true');
                    loadBooks();
                } else {
                    showPinModal.value = true;
                    inputPin.value = '';
                }
            };

            const verifyPin = () => {
                if (inputPin.value === PARENT_LOCK_PIN) {
                    showPinModal.value = false;
                    isKidMode.value = false;
                    localStorage.setItem('PREF_IS_KID_MODE', 'false');
                    loadBooks();
                } else {
                    alert('密码错误');
                }
            };

            const onBookTap = (book) => {
                if (book.isUnlocked) {
                    window.location.href = `reader.html?id=${book._id}`;
                } else {
                    alert('该课程未解锁');
                }
            };

            const goToVocabulary = () => { window.location.href = 'vocabulary.html'; };
            const goToStats = () => { window.location.href = 'stats.html'; };

            onMounted(() => {
                initCloud();
            });

            return {
                CATEGORY_MAP, currentUser, loginCode, filteredBookList, currentCategory, loading, keyword, activeTag,
                isKidMode, showPinModal, inputPin, handleLogin, logout, switchCategory, onSearchInput,
                onTagTap, clearTagFilter, toggleKidMode, verifyPin, onBookTap, goToVocabulary, goToStats
            };
        }
    }).mount('#app');
</script>
