<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>章节列表</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://static.cloudbase.net/cloudbase-js-sdk/2.9.1/cloudbase.full.js"></script>
    
    <style>
        /* === 样式区域 (保持不变) === */
        :root { --primary-color: #07c160; --bg-color: #f6f6f6; }
        body { margin: 0; padding: 0; background-color: var(--bg-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        * { box-sizing: border-box; }
        .container { padding: 10px; min-height: 100vh; padding-bottom: 30px; }
        .filter-bar { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 8px 15px; margin-bottom: 10px; border-radius: 6px; font-size: 14px; color: #07c160; font-weight: bold; box-shadow: 0 1px 5px rgba(0,0,0,0.05); }
        .clear-btn { font-size: 12px; color: #999; font-weight: normal; cursor: pointer; }
        .chapter-card { background: #fff; border-radius: 8px; margin-bottom: 12px; display: flex; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); transition: transform 0.1s; cursor: pointer; overflow: hidden; }
        .card-cover-box { width: 100px; height: 100px; flex-shrink: 0; background: #eee; position: relative; }
        .card-cover { width: 100%; height: 100%; object-fit: cover; display: block; }
        .play-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.5); color: #fff; width: 30px; height: 30px; border-radius: 50%; text-align: center; line-height: 30px; font-size: 14px; }
        .cover-bottom-layer { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0)); display: flex; flex-direction: column; justify-content: flex-end; z-index: 5; padding-top: 10px; }
        .card-info { flex: 1; padding: 8px 10px 6px 10px; display: flex; flex-direction: column; height: 100px; min-width: 0; }
        .card-title { font-size: 15px; font-weight: bold; color: #333; line-height: 1.4; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; margin-bottom: 0; }
        .spacer { flex: 1; }
        .tags-static-box { width: 100%; height: 50px; display: flex; flex-wrap: wrap; align-content: flex-start; overflow: hidden; }
        .tag-item { display: inline-block; font-size: 13px; color: #07c160; background: rgba(7, 193, 96, 0.08); padding: 4px 6px; border-radius: 4px; margin-right: 8px; margin-top: 5px; line-height: 1; cursor: pointer; }
        .chapter-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; font-size: 16px; color: #333; border-bottom: 1px solid #eee; background: #fff; cursor: pointer; }
        .simple-title { display: flex; align-items: flex-start; flex: 1; padding-right: 10px; }
        .simple-title-col { display: flex; flex-direction: column; flex: 1; }
        .idx { color: #999; margin-right: 8px; font-size: 14px; margin-top: 2px; }
        .arrow { color: #ccc; font-size: 20px; }
        .list-progress-row { display: flex; align-items: center; margin-top: 5px; }
        .loading, .empty-tip { text-align: center; color: #999; padding-top: 50px; font-size: 14px; width: 100%; }
        @media screen and (min-width: 500px) {
            .container { max-width: 800px; margin: 0 auto; }
            .card-cover-box { width: 80px; height: 80px; }
            .card-info { height: 80px; }
            .card-title { font-size: 14px; }
            .tag-item { font-size: 10px; padding: 2px 5px; }
        }
    </style>
</head>
<body>

<div id="app">
    <div class="container">
        <!-- 筛选栏 -->
        <div class="filter-bar" v-if="activeTag" @click="clearTag"><span>当前筛选：{{ activeTag }}</span><span class="clear-btn">✕ 清除</span></div>
        <div class="chapter-list-container">
            <div v-if="filteredList.length > 0">
                <div v-for="(item, index) in filteredList" :key="item._id">
                    <div v-if="item.cover_url" class="chapter-card" @click="goToReader(item._id)">
                        <div class="card-cover-box">
                            <img class="card-cover" :src="item.cover_url" loading="lazy">
                            <div class="play-overlay">▶</div>
                            <div class="cover-bottom-layer" v-if="item.hasStarted">
                                <span class="cover-prog-text">{{ item.progressText }}</span>
                            </div>
                        </div>
                        <div class="card-info">
                            <div class="card-title">{{ item.title }}</div><div class="spacer"></div>
                            <div class="tags-static-box" v-if="item.tags && item.tags.length"><span v-for="tag in item.tags" :key="tag" :class="['tag-item', activeTag === tag ? 'active' : '']" @click.stop="onTagTap(tag)">{{ tag }}</span></div>
                        </div>
                    </div>
                    <div v-else class="chapter-item" @click="goToReader(item._id)">
                        <div class="simple-title"><span class="idx">{{ index + 1 }}.</span><div class="simple-title-col"><span class="t-text">{{ item.title }}</span></div></div><span class="arrow">›</span>
                    </div>
                </div>
            </div>
            <div v-else class="empty-tip">{{ loading ? '' : (activeTag ? '该标签下暂无内容' : '暂无章节') }}</div>
        </div>
        <div v-if="loading" class="loading">加载中...</div>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            const db = ref(null);
            const bookId = ref('');
            const bookCategory = ref('audiobook');
            const loading = ref(true);
            const fullChapterList = ref([]);
            const activeTag = ref('');
            const PROGRESS_KEY = 'reader_progress_v1';

            // 1. 加载 SDK
            const loadSdkScript = () => new Promise((resolve, reject) => {
                if (window.cloudbase) return resolve(window.cloudbase);
                const script = document.createElement('script');
                script.src = "https://static.cloudbase.net/cloudbase-js-sdk/2.9.1/cloudbase.full.js";
                script.onload = () => resolve(window.cloudbase);
                script.onerror = () => reject(new Error("SDK load failed"));
                document.head.appendChild(script);
            });

            // 2. 初始化
            const initCloud = async () => {
                const urlParams = new URLSearchParams(window.location.search);
                const id = urlParams.get('bookId');
                if (!id) return alert('缺少 Book ID');
                bookId.value = id;
                if (!localStorage.getItem('web_user')) { alert('请先登录'); window.location.href = 'index.html'; return; }

                try {
                    const cloudbase = await loadSdkScript();
                    const app = cloudbase.init({ env: 'cloud1-4gcnkqkl8e5bcae5', region: 'ap-shanghai' });
                    const auth = app.auth({ persistence: 'local' });
                    if (!auth.hasLoginState()) await auth.signInAnonymously();
                    db.value = app.database();
                    loadBookInfoAndChapters();
                } catch (e) {
                    console.error('Cloud init failed', e);
                    window.location.href = 'index.html';
                }
            };
            
            // 3. 核心修改：修复了 res.data 的错误
            const loadBookInfoAndChapters = async () => {
                loading.value = true;
                try {
                    // 查书籍信息
                    const bookRes = await db.value.collection('books').doc(bookId.value).get();
                    if (bookRes.data && bookRes.data.length > 0) {
                        bookCategory.value = bookRes.data[0].category || 'audiobook';
                        document.title = bookRes.data[0].title || '章节列表';
                    }

                    // 查章节
const res = await db.value.collection('chapters')
    .where({ book_id: bookId.value }) // ✅ 正确：改成 book_id (带下划线)
    .limit(1000)
    .get();                    
                    // ✅ 核心修复：先判断 res.data 是否存在
                    const list = res.data || [];
                    
                    if (list.length === 0) {
                        console.warn("未查到章节，请检查：\n1. chapters 表权限是否为【所有用户可读】\n2. 数据库中 chapters 表是否有 bookId 为 '" + bookId.value + "' 的记录");
                    }

                    list.sort((a, b) => {
                        const titleA = a.title || '', titleB = b.title || '';
                        if (bookCategory.value === 'podcast' || bookCategory.value === 'youtube') {
                            return titleB.localeCompare(titleA, undefined, { numeric: true });
                        }
                        return titleA.localeCompare(titleB, undefined, { numeric: true });
                    });

                    updateListWithProgress(list);

                } catch (err) {
                    console.error("Query DB Error:", err);
                    alert("加载失败，请检查数据库权限或网络");
                } finally {
                    loading.value = false;
                }
            };
            
            // 业务逻辑 (保持不变)
            const updateListWithProgress = (list) => {
                const progressJson = localStorage.getItem(PROGRESS_KEY);
                const progressMap = progressJson ? JSON.parse(progressJson) : {};
                const processedList = list.map(item => {
                    const key = `${bookId.value}_${item._id}`;
                    const currentIndex = progressMap[key] || 0;
                    // ... 进度条逻辑 (省略)
                    return { ...item, hasStarted: currentIndex > 0 };
                });
                fullChapterList.value = processedList;
            };
            const onTagTap = (tag) => { activeTag.value = activeTag.value === tag ? '' : tag; };
            const clearTag = () => { activeTag.value = ''; };
            const goToReader = (chapterId) => { window.location.href = `reader.html?chapterId=${chapterId}&bookId=${bookId.value}`; };
            const filteredList = computed(() => {
                if (!activeTag.value) return fullChapterList.value;
                return fullChapterList.value.filter(item => item.tags && item.tags.includes(activeTag.value));
            });

            onMounted(() => { initCloud(); });

            return { loading, filteredList, activeTag, onTagTap, clearTag, goToReader };
        }
    }).mount('#app');
</script>
</body>
</html>
