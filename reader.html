<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Web Reader Pro (Ultimate Fix)</title>
    <!-- 引入 Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 引入 Cloudbase (如果不使用云开发可移除) -->
    <script src="https://static.cloudbase.net/cloudbase-js-sdk/2.9.1/cloudbase.full.js"></script>
    
    <style>
        /* ================= 基础重置 ================= */
        :root { --primary-color: #07c160; --safe-bottom: env(safe-area-inset-bottom); }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; overflow: hidden; height: 100vh; user-select: none; background: #f7f7f7; color: #333; }
        * { box-sizing: border-box; }
        ::-webkit-scrollbar { width: 0; height: 0; display: none; }
        
        /* 布局容器 */
        .page-container { height: 100vh; display: flex; flex-direction: column; position: relative; transition: background-color 0.3s; overflow: hidden; }
        
        /* 主题配色 */
        .theme-0 { background-color: #f7f7f7; --text-main: #2c2c2e; --text-sub: #888; --active-bg: #f8f3d7; --active-border: #d4b162; }
        .theme-1 { background-color: #f6f1e1; --text-main: #16120d; --text-sub: #7a6e5d; --active-bg: #eaddc5; --active-border: #8c7b64; }
        .theme-2 { background-color: #d7f1da; --text-main: #0b0f0c; --text-sub: #5e7063; --active-bg: #b5dcb9; --active-border: #4a6652; }
        .theme-3 { background-color: #1c1c1e; --text-main: #e5e5e5; --text-sub: #888; --active-bg: #333; --active-border: #fff; }

        .watermark { position: fixed; top: 10px; right: 10px; font-size: 10px; color: rgba(0,0,0,0.08); pointer-events: none; z-index: 99; }
        .theme-3 .watermark { color: rgba(255,255,255,0.08); }

        /* ================= 视频/顶部区域 ================= */
        .video-panel-wrapper {
            flex-shrink: 0; 
            width: 94%; 
            margin: 10px auto 5px; 
            background: #000; 
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            overflow: hidden;
            display: flex; flex-direction: column;
            z-index: 50;
            transition: height 0.3s;
        }
        .theme-3 .video-panel-wrapper { border: 1px solid #333; }

        .media-wrapper {
            position: relative;
            width: 100%;
            height: 210px; /* 固定高度，防止跳动 */
            background: #000;
        }

        .main-media, .cover-art-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        }
        .main-media { object-fit: contain; z-index: 1; }
        .cover-art-container { z-index: 1; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .cover-art-bg { position: absolute; width: 100%; height: 100%; filter: blur(20px) brightness(0.7); object-fit: cover; transform: scale(1.2); }
        .cover-art-fg { position: relative; z-index: 2; height: 80%; width: auto; max-width: 80%; object-fit: contain; box-shadow: 0 5px 15px rgba(0,0,0,0.3); border-radius: 4px; }

        /* 视频内注解层 */
        .video-subtitle-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 8px; z-index: 10; pointer-events: none;
            display: flex; flex-direction: column;
            overflow-y: auto;
        }
        .v-note-item {
            align-self: flex-start;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
            border-radius: 4px; padding: 4px 8px; margin-bottom: 6px;
            border: 1px solid rgba(255,255,255,0.15);
            font-size: 13px; color: #fff;
            pointer-events: auto; cursor: pointer;
            max-width: 90%;
        }
        .note-en { color: #ffcc00; font-weight: bold; margin-right: 5px; }

        /* 固定字幕栏 */
        .fixed-subtitle-bar {
            background: inherit;
            padding: 12px 15px;
            border-top: 1px solid rgba(0,0,0,0.05);
            position: relative;
        }
        .theme-3 .fixed-subtitle-bar { background: #2c2c2e; border-top-color: #333; }
        .fixed-subtitle-bar .en-text { font-size: 17px; font-weight: 600; color: var(--text-main); line-height: 1.4; }
        .fixed-subtitle-bar .cn-text { font-size: 14px; color: var(--text-sub); margin-top: 6px; line-height: 1.4; }

        /* ================= 列表内容区 ================= */
        .content-area { 
            flex: 1; 
            overflow-y: auto; 
            padding: 10px 12px calc(80px + var(--safe-bottom)) 12px; /* 底部留白给播放条 */
            scroll-behavior: auto; /* JS控制滚动，这里设为auto */
            -webkit-overflow-scrolling: touch;
        }
        /* 专注模式：视频开启且字幕栏开启时，列表变淡 */
        .content-area.focus-mode .sentence-group:not(.active) { opacity: 0.3; filter: blur(0.5px); transition: all 0.5s; }
        
        .sentence-group { 
            padding: 10px 12px; margin-bottom: 12px; 
            border-radius: 8px; 
            border-left: 4px solid transparent; 
            transition: all 0.25s ease;
            cursor: pointer; 
        }
        /* 激活状态 */
        .sentence-group.active { 
            background: var(--active-bg); 
            border-left-color: var(--active-border);
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .en-text { font-size: 18px; line-height: 1.5; color: var(--text-main); word-wrap: break-word; }
        .cn-text { font-size: 15px; line-height: 1.5; color: var(--text-sub); margin-top: 6px; min-height: 1em; }
        
        /* 关键词 */
        .keyword { border-bottom: 1px dotted rgba(150,150,150,0.5); padding-bottom: 1px; }
        .bold-keywords .keyword { font-weight: 700; }
        
        /* 遮盖模式 */
        .mask-layout { 
            background: #e0e0e0; color: transparent !important; border-radius: 4px; 
            user-select: none; transition: all 0.2s;
        }
        .theme-3 .mask-layout { background: #333; }
        .sentence-group.revealed .mask-layout { background: transparent; color: var(--text-sub) !important; }

        /* 字体大小类 */
        .fs-small .en-text { font-size: 16px; } 
        .fs-normal .en-text { font-size: 18px; } 
        .fs-large .en-text { font-size: 20px; } 
        .fs-xlarge .en-text { font-size: 24px; }

        /* ================= 气泡 (Popover) ================= */
        .popover { 
            position: fixed; 
            background: #222; color: #fff; 
            padding: 12px 16px; 
            border-radius: 8px; 
            font-size: 14px; line-height: 1.5;
            max-width: 280px; 
            z-index: 1000; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: popFadeIn 0.2s ease-out;
        }
        .theme-3 .popover { background: #444; border: 1px solid #555; }
        .pop-arrow { position: absolute; width: 0; height: 0; border: 6px solid transparent; }
        /* 箭头朝下 (默认) */
        .pop-arrow.bottom { border-top-color: #222; bottom: -12px; left: 50%; transform: translateX(-50%); }
        .theme-3 .pop-arrow.bottom { border-top-color: #444; }
        /* 箭头朝上 (当气泡在下方时) */
        .pop-arrow.top { border-bottom-color: #222; top: -12px; left: 50%; transform: translateX(-50%); }
        .theme-3 .pop-arrow.top { border-bottom-color: #444; }

        @keyframes popFadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* ================= 底部播放栏 ================= */
        .player-bar-wrapper { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            z-index: 600; 
            background: rgba(255,255,255,0.92); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 -1px 0 rgba(0,0,0,0.05); 
            padding-bottom: var(--safe-bottom);
        }
        .theme-3 .player-bar-wrapper { background: rgba(30,30,32,0.92); box-shadow: 0 -1px 0 rgba(255,255,255,0.1); }

        /* 进度条区域 (加大触控区域) */
        .progress-float-container {
            position: absolute; top: -20px; left: 0; width: 100%; height: 40px;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .progress-float-container.show { opacity: 1; pointer-events: auto; }
        
        .progress-pill {
            background: #fff; padding: 0 15px; height: 36px; border-radius: 18px;
            display: flex; align-items: center; width: 90%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05);
        }
        .theme-3 .progress-pill { background: #333; border-color: #444; }

        .time-txt { font-size: 11px; font-variant-numeric: tabular-nums; color: #888; width: 40px; text-align: center; }
        .seek-slider { 
            flex: 1; margin: 0 10px; -webkit-appearance: none; height: 20px; background: transparent; 
            position: relative; 
        }
        /* 伪造一个细轨道 */
        .seek-slider::after {
            content: ''; position: absolute; left: 0; top: 9px; width: 100%; height: 2px; 
            background: #ddd; border-radius: 1px; z-index: -1;
        }
        .theme-3 .seek-slider::after { background: #555; }
        /* 拇指样式 */
        .seek-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; 
            background: #333; box-shadow: 0 1px 3px rgba(0,0,0,0.3); transform: translateY(-1px);
        }
        .theme-3 .seek-slider::-webkit-slider-thumb { background: #fff; }

        /* 按钮控制区 */
        .controls-row { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        
        .c-btn { 
            width: 44px; height: 44px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 18px; background: transparent; color: var(--text-main);
            transition: background 0.2s;
        }
        .c-btn:active { background: rgba(0,0,0,0.05); }
        .theme-3 .c-btn:active { background: rgba(255,255,255,0.1); }
        
        .play-btn { 
            width: 56px; height: 56px; font-size: 24px; 
            background: var(--text-main); color: var(--active-bg); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .theme-3 .play-btn { background: #eee; color: #000; }

        .mode-tag { 
            padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; 
            background: #eee; color: #666; 
        }
        .mode-tag.active { background: var(--primary-color); color: #fff; }

        /* ================= 设置弹窗 ================= */
        .settings-panel {
            position: fixed; bottom: calc(70px + var(--safe-bottom)); left: 5%; width: 90%;
            background: #fff; border-radius: 16px; 
            padding: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            z-index: 650; display: flex; gap: 10px; overflow-x: auto;
        }
        .theme-3 .settings-panel { background: #2c2c2e; border: 1px solid #444; }
        .set-item { 
            flex: 0 0 60px; text-align: center; padding: 5px; 
            border-radius: 8px; cursor: pointer; 
        }
        .set-item:active { background: rgba(0,0,0,0.05); }
        .set-lbl { font-size: 10px; color: #999; margin-bottom: 4px; }
        .set-val { font-size: 13px; font-weight: 600; color: var(--text-main); }

        /* ================= 辅助元素 ================= */
        .loading-mask { 
            position: fixed; inset: 0; background: rgba(255,255,255,0.9); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 2000; color: #333; 
        }
        .theme-3 .loading-mask { background: #000; color: #fff; }
        .toast { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: rgba(0,0,0,0.8); color: #fff; 
            padding: 10px 20px; border-radius: 8px; font-size: 14px; 
            z-index: 3000; pointer-events: none; opacity: 0; transition: opacity 0.3s; 
        }
        .toast.show { opacity: 1; }

    </style>
</head>
<body>

<div id="app">
    <div :class="['page-container', 'theme-' + themeIndex]" @click="onContainerClick" @touchstart="handleTouchStart" @touchend="handleTouchEnd">
        
        <div class="watermark">{{ watermarkText }}</div>

        <!-- 顶部：视频/音频封面区域 -->
        <div class="video-panel-wrapper" v-if="showVideoMode">
            <div class="media-wrapper">
                <!-- 视频元素 -->
                <video v-if="videoUrl" ref="videoPlayer" class="main-media" 
                       :src="videoUrl" playsinline webkit-playsinline
                       @timeupdate="onMediaTimeUpdate" @ended="onChapterEnd" 
                       @play="onMediaStateChange(true)" @pause="onMediaStateChange(false)"
                       @click.stop="togglePlay">
                </video>
                <!-- 音频封面 (当开启视频模式但无视频URL，或强制封面时) -->
                <div v-else class="cover-art-container" @click.stop="togglePlay">
                    <img class="cover-art-bg" :src="coverUrl || demoCover" />
                    <img class="cover-art-fg" :src="coverUrl || demoCover" />
                </div>
                
                <!-- 视频上的单词注解浮层 -->
                <div class="video-subtitle-overlay" v-if="currentNoteSegments.length > 0">
                    <div class="v-note-item" v-for="(item, idx) in currentNoteSegments" :key="idx" 
                         @click.stop="showPopover(item, $event, 'video')">
                        <span class="note-en">{{item.prefix}}</span>
                        <span>{{item.suffix}}</span>
                    </div>
                </div>
            </div>

            <!-- 固定在视频下方的字幕条 -->
            <div class="fixed-subtitle-bar" v-if="useFixedSubtitleBar && sentences[currentIndex]">
                <div class="en-text">
                    <span v-for="(seg, i) in sentences[currentIndex].en_segments" :key="i">
                        <span v-if="seg.type === 'keyword'" class="keyword" 
                              :style="{color: seg.color || 'var(--primary-color)'}" 
                              @click.stop="showPopover(seg, $event, 'bar')">{{ seg.text }}</span>
                        <span v-else>{{ seg.text }}</span>
                    </span>
                </div>
                <div class="cn-text" v-if="showCN">{{ sentences[currentIndex].cn_text }}</div>
            </div>
        </div>

        <!-- 中部：句子列表 -->
        <div class="content-area" 
             ref="contentArea" 
             :class="[fontSizes[currentFontSizeIndex].class, isBold?'bold-keywords':'', (showVideoMode && useFixedSubtitleBar) ? 'focus-mode' : '']"
             :style="{ fontFamily: fonts[currentFontIndex].value }"
             @scroll="onListScroll">
             
            <div v-for="(item, index) in sentences" :key="index" 
                 :id="'sent-' + index"
                 class="sentence-group" 
                 :class="{ 'active': currentIndex === index, 'revealed': revealedMap[index] }"
                 @click.stop="playAt(index)">
                 
                 <div class="en-text">
                    <span v-for="(seg, i) in item.en_segments" :key="i">
                        <span v-if="seg.type === 'keyword'" class="keyword" 
                              :style="{color: seg.color}" 
                              @click.stop="showPopover(seg, $event, 'list')">{{ seg.text }}</span>
                        <span v-else>{{ seg.text }}</span>
                    </span>
                </div>
                
                <div class="cn-text" 
                     :class="{'mask-layout': maskMode && !revealedMap[index]}" 
                     v-if="displayMode !== 3"
                     @click.stop="toggleReveal(index)">
                     {{ item.cn_text }}
                </div>
            </div>
        </div>

        <!-- 单词气泡 Popover -->
        <div class="popover" v-if="popData.show" :style="popData.style" @click.stop="addToBook">
            <div style="font-weight:bold; margin-bottom:4px; color:#ffcc00">{{ popData.text }}</div>
            <div style="white-space: pre-wrap;">{{ popData.note }}</div>
            <div style="font-size:10px; opacity:0.6; margin-top:8px; border-top:1px solid rgba(255,255,255,0.2); padding-top:4px; text-align:right;">
                点击收藏
            </div>
            <div :class="['pop-arrow', popData.arrowPos]" :style="popData.arrowStyle"></div>
        </div>

        <!-- 底部设置面板 -->
        <div class="settings-panel" v-if="showSettings">
            <div class="set-item" @click="toggleVideoMode"><div class="set-lbl">模式</div><div class="set-val">{{ showVideoMode ? '视频' : '音频' }}</div></div>
            <div class="set-item" @click="cycleSpeed"><div class="set-lbl">倍速</div><div class="set-val">{{ playbackRates[speedIndex] }}x</div></div>
            <div class="set-item" @click="cycleLoop"><div class="set-lbl">循环</div><div class="set-val">{{ loopModes[loopModeIndex] }}</div></div>
            <div class="set-item" @click="cycleDisplay"><div class="set-lbl">显示</div><div class="set-val">{{ displayModes[displayModeIndex] }}</div></div>
            <div class="set-item" @click="cycleTheme"><div class="set-lbl">主题</div><div class="set-val">{{ themeNames[themeIndex] }}</div></div>
            <div class="set-item" @click="cycleFont"><div class="set-lbl">字体</div><div class="set-val">{{ fonts[currentFontIndex].name }}</div></div>
        </div>

        <!-- 底部播放控制条 -->
        <div class="player-bar-wrapper">
            <!-- 悬浮进度条 (操作时或暂停时显示) -->
            <div class="progress-float-container" :class="{show: isSeeking || !isPlaying || showSettings}">
                <div class="progress-pill">
                    <span class="time-txt">{{ formatTime(currentTime) }}</span>
                    <input type="range" class="seek-slider" min="0" max="100" step="0.1"
                           :value="progressPercent" 
                           @input="onSeekInput" @change="onSeekChange">
                    <span class="time-txt">{{ formatTime(duration) }}</span>
                </div>
            </div>

            <div class="controls-row">
                <div class="c-btn" @click.stop="showSettings = !showSettings">☰</div>
                
                <div style="display:flex; gap:25px; align-items:center;">
                    <div class="c-btn" @click.stop="playPrev">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                    </div>
                    <div class="c-btn play-btn" @click.stop="togglePlay">
                        <span v-if="!isPlaying">▶</span>
                        <span v-else style="font-size:20px; font-weight:bold;">❚❚</span>
                    </div>
                    <div class="c-btn" @click.stop="playNext">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                    </div>
                </div>

                <div class="mode-tag" :class="{active: autoScrollMode}" @click.stop="toggleScrollMode">
                    {{ autoScrollMode ? '听书' : '手动' }}
                </div>
            </div>
        </div>

        <!-- Loading / Toast -->
        <div class="loading-mask" v-if="isLoading">
            <div style="font-size:18px; font-weight:bold; margin-bottom:10px;">{{ loadingText }}</div>
            <div v-if="isDemoMode" style="font-size:12px; color:#666;">(Demo Mode)</div>
        </div>
        <div :class="['toast', {show: toast.show}]">{{ toast.msg }}</div>
    </div>
</div>

<script>
const { createApp, ref, reactive, computed, onMounted, onUnmounted, nextTick, watch } = Vue;

// 演示数据 (当云端加载失败时使用)
const DEMO_DATA = {
    title: "Steve Jobs Stanford Speech",
    audio: "https://dict.youdao.com/dictvoice?audio=Stay%20hungry%2C%20stay%20foolish.&type=2", // 仅作示例
    video: "https://media.w3.org/2010/05/sintel/trailer.mp4",
    cover: "https://via.placeholder.com/600x400/000000/FFFFFF?text=Audio+Cover",
    content: [
        { start: 0, end: 3.5, en_segments: [{text:"I am honored to be with you today", type:"text"}], cn_text: "我很荣幸今天能和你们在一起" },
        { start: 3.5, end: 7.0, en_segments: [{text:"at your ", type:"text"}, {text:"commencement", type:"keyword", note:"n. 毕业典礼; 开始", color:"#e74c3c"}, {text:" from one of the finest universities in the world.", type:"text"}], cn_text: "参加这所世界上最好大学之一的毕业典礼。" },
        { start: 7.0, end: 12.0, en_segments: [{text:"I never graduated from college.", type:"text"}], cn_text: "我从未从大学毕业。" },
        { start: 12.0, end: 16.5, en_segments: [{text:"Truth be told, this is the closest I've ever gotten to a college graduation.", type:"text"}], cn_text: "说实话，这是我离大学毕业最近的一次。" },
        { start: 16.5, end: 20.0, en_segments: [{text:"Today I want to tell you three stories from my life.", type:"text"}], cn_text: "今天我想给你们讲三个我生活中的故事。" },
        { start: 20.0, end: 25.0, en_segments: [{text:"That's it. No big deal. Just three stories.", type:"text"}], cn_text: "就这样。没什么大不了的。只是三个故事。" },
        { start: 25.0, end: 30.0, en_segments: [{text:"The first story is about connecting the dots.", type:"text"}], cn_text: "第一个故事是关于串连生命中的点滴。" }
    ]
};

createApp({
    setup() {
        // --- 状态变量 ---
        const isLoading = ref(true);
        const loadingText = ref('资源加载中...');
        const isDemoMode = ref(false);
        const toast = reactive({ show: false, msg: '' });
        
        const sentences = ref([]);
        const currentIndex = ref(0);
        const videoUrl = ref('');
        const audioUrl = ref('');
        const coverUrl = ref('');
        const demoCover = "https://via.placeholder.com/400x300?text=No+Cover";
        
        // 播放器状态
        const audioObj = new Audio();
        const videoPlayer = ref(null);
        const isPlaying = ref(false);
        const currentTime = ref(0);
        const duration = ref(1); // 避免除以0
        const progressPercent = ref(0);
        const isSeeking = ref(false);
        
        // 偏好设置
        const themeIndex = ref(0);
        const themeNames = ['简约白', '羊皮纸', '护眼绿', '深邃黑'];
        
        const showVideoMode = ref(false); // 视频模式开关
        const useFixedSubtitleBar = ref(true); // 视频下方的固定字幕条
        
        const speedIndex = ref(2);
        const playbackRates = [0.5, 0.8, 1.0, 1.25, 1.5, 2.0];
        
        const loopModeIndex = ref(0);
        const loopModes = ['顺序播放', '单句循环', '单句×3', '跟读模式'];
        
        const displayModeIndex = ref(0); // 0:双语, 1:纯英, 2:遮盖, 3:无字
        const displayModes = ['中英双语', '仅英文', '点击译文', '隐藏文本'];
        const showCN = computed(() => displayModeIndex.value === 0 || displayModeIndex.value === 2);
        const maskMode = computed(() => displayModeIndex.value === 2);
        const revealedMap = ref({}); // 记录遮盖模式下哪些句子被点开了

        const autoScrollMode = ref(true); // 是否自动跟随滚动
        const showSettings = ref(false);

        // 字体设置
        const fonts = [
            { name: '系统', value: '-apple-system, BlinkMacSystemFont, sans-serif' },
            { name: '衬线', value: '"Georgia", serif' },
            { name: '圆体', value: '"Varela Round", sans-serif' }
        ];
        const currentFontIndex = ref(0);
        const fontSizes = [{class:'fs-small'}, {class:'fs-normal'}, {class:'fs-large'}, {class:'fs-xlarge'}];
        const currentFontSizeIndex = ref(1);
        const isBold = ref(false);

        // 气泡逻辑
        const popData = reactive({ show: false, text: '', note: '', style: {}, arrowStyle: {}, arrowPos: 'bottom' });
        const currentNoteSegments = ref([]); // 视频画面上的注解

        // 触控相关
        let touchStartX = 0, touchStartY = 0;
        let shadowTimer = null; // 跟读定时器

        // --- 初始化 ---
        onMounted(async () => {
            // 从 localStorage 恢复设置
            loadSettings();
            
            // 尝试加载云端数据 (模拟)
            try {
                // 这里模拟一个网络请求延迟
                await new Promise(r => setTimeout(r, 800));
                
                // 假设获取不到真实数据，使用 Demo 数据
                // 实际项目中请替换为真实的 Cloudbase 调用
                throw new Error("Force Demo Mode");
            } catch (e) {
                console.warn("Using Demo Data", e);
                loadData(DEMO_DATA);
                isDemoMode.value = true;
            } finally {
                isLoading.value = false;
            }

            // 监听音频对象事件
            audioObj.addEventListener('timeupdate', () => syncProgress(audioObj));
            audioObj.addEventListener('ended', onChapterEnd);
            audioObj.addEventListener('play', () => isPlaying.value = true);
            audioObj.addEventListener('pause', () => isPlaying.value = false);
            audioObj.addEventListener('loadedmetadata', () => duration.value = audioObj.duration);
            
            window.addEventListener('resize', () => popData.show = false);
        });

        const loadData = (data) => {
            document.title = data.title;
            sentences.value = data.content;
            audioUrl.value = data.audio;
            videoUrl.value = data.video;
            coverUrl.value = data.cover;
            
            // 初始化音频源
            audioObj.src = audioUrl.value;
            // 如果有历史记录，可以跳到历史位置
            updateSentenceIndex(0);
        };

        // --- 核心播放逻辑 ---
        
        // 获取当前活跃的媒体元素 (Video 或 Audio)
        const getActiveMedia = () => {
            return (showVideoMode.value && videoUrl.value && videoPlayer.value) ? videoPlayer.value : audioObj;
        };

        const togglePlay = () => {
            const media = getActiveMedia();
            if (media.paused) {
                media.playbackRate = playbackRates[speedIndex.value];
                media.play().catch(e => showToast('播放失败，请重试'));
            } else {
                media.pause();
            }
            showSettings.value = false;
            popData.show = false;
        };

        const playAt = (index) => {
            if (index < 0 || index >= sentences.value.length) return;
            
            // 清除之前的状态
            clearTimeout(shadowTimer);
            
            // 切换句子
            currentIndex.value = index;
            const sent = sentences.value[index];
            const media = getActiveMedia();
            
            // 稍作偏移，避免卡在上一句末尾
            media.currentTime = sent.start + 0.01;
            media.play();
            
            if (autoScrollMode.value) scrollToCenter(index);
        };

        const playPrev = () => playAt(currentIndex.value - 1);
        const playNext = () => playAt(currentIndex.value + 1);

        // 媒体时间更新 (核心同步)
        const syncProgress = (media) => {
            if (isSeeking.value) return; // 拖拽中不更新
            
            const t = media.currentTime;
            const d = media.duration || 1;
            currentTime.value = t;
            duration.value = d;
            progressPercent.value = (t / d) * 100;

            // 查找当前句子
            // 优化：先检查当前句子是否匹配，不匹配再全局搜
            const curSent = sentences.value[currentIndex.value];
            if (curSent && t >= curSent.start && t < curSent.end) {
                // 还在当前句，检查循环逻辑
                handleLoopLogic(media, curSent, t);
            } else {
                // 离开了当前句
                const newIdx = sentences.value.findIndex(s => t >= s.start && t < s.end);
                if (newIdx !== -1 && newIdx !== currentIndex.value) {
                    updateSentenceIndex(newIdx);
                    if (autoScrollMode.value) scrollToCenter(newIdx);
                }
            }
        };

        // 视频组件的事件代理
        const onMediaTimeUpdate = (e) => syncProgress(e.target);
        const onMediaStateChange = (playing) => isPlaying.value = playing;

        // 循环/跟读逻辑控制
        let loopCount = 0;
        const handleLoopLogic = (media, sent, t) => {
            const mode = loopModes[loopModeIndex.value];
            
            // 1. 单句循环
            if (mode === '单句循环') {
                if (t >= sent.end - 0.2) {
                    media.currentTime = sent.start;
                }
            }
            // 2. 单句x3
            else if (mode === '单句×3') {
                if (t >= sent.end - 0.2) {
                    if (loopCount < 2) {
                        media.currentTime = sent.start;
                        loopCount++;
                    } else {
                        // 播放完3次，继续走，不需要代码干预，自然会滑到下一句
                        // 但需要在进入下一句时重置 count (在 updateSentenceIndex 里做)
                    }
                }
            }
            // 3. 跟读模式 (影子跟读)
            else if (mode === '跟读模式') {
                if (t >= sent.end - 0.1 && !media.paused) {
                    media.pause();
                    const pauseTime = (sent.end - sent.start) * 1000 * 1.5; // 停顿1.5倍时长
                    showToast('请跟读...');
                    shadowTimer = setTimeout(() => {
                        playNext();
                    }, pauseTime);
                }
            }
        };

        const updateSentenceIndex = (idx) => {
            currentIndex.value = idx;
            loopCount = 0; // 重置循环计数
            
            // 提取视频注解
            const s = sentences.value[idx];
            if (s && s.en_segments) {
                // 简单的去重提取 note
                const notes = [];
                s.en_segments.forEach(seg => {
                    if (seg.type === 'keyword' && seg.note) {
                        const parts = seg.note.split(/[:：]/);
                        notes.push({ 
                            prefix: parts[0] || seg.text, 
                            suffix: parts[1] || '',
                            note: seg.note,
                            fullText: seg.text
                        });
                    }
                });
                currentNoteSegments.value = notes;
            } else {
                currentNoteSegments.value = [];
            }
        };

        // --- UI 交互逻辑 ---

        // 修复：完美的平滑滚动
        const scrollToCenter = (index) => {
            nextTick(() => {
                const el = document.getElementById('sent-' + index);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        };

        // 修复：无缝切换音视频
        const toggleVideoMode = () => {
            const oldMedia = getActiveMedia();
            const wasPlaying = !oldMedia.paused;
            const time = oldMedia.currentTime;
            
            oldMedia.pause();
            showVideoMode.value = !showVideoMode.value;
            saveSettings();

            nextTick(() => {
                const newMedia = getActiveMedia();
                newMedia.currentTime = time;
                newMedia.playbackRate = playbackRates[speedIndex.value];
                if (wasPlaying) newMedia.play();
                
                // 如果开启视频，自动滚到顶部看视频
                if (showVideoMode.value) {
                   document.querySelector('.content-area')?.scrollTo({top:0, behavior:'smooth'});
                } else {
                   scrollToCenter(currentIndex.value);
                }
            });
        };

        // 修复：智能气泡定位
        const showPopover = (seg, event, source) => {
            // 如果是点击视频里的浮层，先暂停
            getActiveMedia().pause();
            
            const text = seg.text || seg.fullText || seg.prefix;
            const note = seg.note || seg.suffix; // 兼容不同结构
            
            popData.text = text;
            popData.note = note;
            popData.show = true;
            
            nextTick(() => {
                const rect = event.target.getBoundingClientRect();
                const popEl = document.querySelector('.popover');
                if (!popEl) return;
                
                const popWidth = popEl.offsetWidth;
                const popHeight = popEl.offsetHeight;
                const screenW = window.innerWidth;
                
                // 1. 水平定位 (防止溢出)
                let left = rect.left + (rect.width / 2) - (popWidth / 2);
                if (left < 10) left = 10;
                else if (left + popWidth > screenW - 10) left = screenW - popWidth - 10;
                
                // 2. 箭头水平定位 (相对于 Popover)
                // 箭头的中心点应该对齐 rect 的中心点
                let arrowLeft = (rect.left + rect.width / 2) - left - 6; // 6是border宽度
                
                // 3. 垂直定位
                let top = rect.top - popHeight - 12;
                let arrowPos = 'bottom';
                
                // 如果上方空间不足，改在下方显示
                if (top < 50) { 
                    top = rect.bottom + 12;
                    arrowPos = 'top';
                }

                popData.style = { top: top + 'px', left: left + 'px' };
                popData.arrowStyle = { left: arrowLeft + 'px' };
                popData.arrowPos = arrowPos;
            });
        };

        // 进度条拖拽
        const onSeekInput = (e) => {
            isSeeking.value = true;
            const pct = e.target.value;
            progressPercent.value = pct;
            currentTime.value = (pct / 100) * duration.value;
        };
        const onSeekChange = (e) => {
            const pct = e.target.value;
            const media = getActiveMedia();
            if (media && duration.value) {
                media.currentTime = (pct / 100) * duration.value;
            }
            // 稍微延迟释放锁，防止timeupdate跳回
            setTimeout(() => { isSeeking.value = false; }, 200);
        };

        // 触控滑动翻页
        const handleTouchStart = (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        };
        const handleTouchEnd = (e) => {
            const dx = e.changedTouches[0].clientX - touchStartX;
            const dy = e.changedTouches[0].clientY - touchStartY;
            
            // 优化：只有横向移动明显大于纵向移动时才触发，防止滚动时误触
            if (Math.abs(dx) > 60 && Math.abs(dx) > Math.abs(dy) * 2) {
                if (dx < 0) playNext();
                else playPrev();
            }
        };

        // --- 辅助功能 ---
        const onChapterEnd = () => {
            isPlaying.value = false;
            showToast('本章结束');
        };

        const toggleScrollMode = () => {
            autoScrollMode.value = !autoScrollMode.value;
            if (autoScrollMode.value) scrollToCenter(currentIndex.value);
            showToast(autoScrollMode.value ? '已开启自动滚屏' : '已切换手动滚动');
        };

        const addToBook = () => {
            showToast('已加入生词本 (模拟)');
            popData.show = false;
        };

        const toggleReveal = (idx) => {
            if (maskMode.value) {
                revealedMap.value[idx] = !revealedMap.value[idx];
            }
        };

        const cycleSpeed = () => {
            speedIndex.value = (speedIndex.value + 1) % playbackRates.length;
            getActiveMedia().playbackRate = playbackRates[speedIndex.value];
            saveSettings();
        };
        const cycleLoop = () => { loopModeIndex.value = (loopModeIndex.value + 1) % loopModes.length; saveSettings(); };
        const cycleDisplay = () => { displayModeIndex.value = (displayModeIndex.value + 1) % displayModes.length; revealedMap.value = {}; saveSettings(); };
        const cycleTheme = () => { themeIndex.value = (themeIndex.value + 1) % themeNames.length; saveSettings(); };
        const cycleFont = () => { currentFontIndex.value = (currentFontIndex.value + 1) % fonts.length; saveSettings(); };

        const formatTime = (s) => {
            if (!s || isNaN(s)) return '00:00';
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec.toString().padStart(2, '0')}`;
        };

        const showToast = (msg) => {
            toast.msg = msg;
            toast.show = true;
            setTimeout(() => toast.show = false, 2000);
        };

        // 本地存储
        const SETTING_KEY = 'web_reader_pref_v2';
        const saveSettings = () => {
            const s = {
                theme: themeIndex.value,
                video: showVideoMode.value,
                speed: speedIndex.value,
                loop: loopModeIndex.value,
                display: displayModeIndex.value,
                font: currentFontIndex.value
            };
            localStorage.setItem(SETTING_KEY, JSON.stringify(s));
        };
        const loadSettings = () => {
            try {
                const s = JSON.parse(localStorage.getItem(SETTING_KEY));
                if (s) {
                    if (s.theme !== undefined) themeIndex.value = s.theme;
                    if (s.video !== undefined) showVideoMode.value = s.video;
                    if (s.speed !== undefined) speedIndex.value = s.speed;
                    if (s.loop !== undefined) loopModeIndex.value = s.loop;
                    if (s.display !== undefined) displayModeIndex.value = s.display;
                    if (s.font !== undefined) currentFontIndex.value = s.font;
                }
            } catch(e){}
        };

        const onContainerClick = () => {
            popData.show = false;
            showSettings.value = false;
        };

        // 返回 setup 对象
        return {
            isLoading, loadingText, isDemoMode, toast,
            watermarkText: 'Web Reader Pro',
            sentences, currentIndex, videoUrl, coverUrl, demoCover,
            showVideoMode, useFixedSubtitleBar,
            audioObj, videoPlayer, isPlaying, currentTime, duration, progressPercent, isSeeking,
            themeIndex, themeNames, fontSizes, currentFontSizeIndex, fonts, currentFontIndex, isBold,
            playbackRates, speedIndex, loopModes, loopModeIndex, displayModes, displayModeIndex,
            showCN, maskMode, revealedMap, autoScrollMode, showSettings,
            popData, currentNoteSegments,
            
            // 方法
            togglePlay, playPrev, playNext, playAt,
            onMediaTimeUpdate, onMediaStateChange, onChapterEnd,
            toggleVideoMode, cycleSpeed, cycleLoop, cycleDisplay, cycleTheme, cycleFont,
            onSeekInput, onSeekChange,
            handleTouchStart, handleTouchEnd,
            scrollToCenter, toggleScrollMode,
            showPopover, addToBook, toggleReveal,
            onContainerClick, onListScroll: () => {}, formatTime
        };
    }
}).mount('#app');
</script>
</body>
</html>
