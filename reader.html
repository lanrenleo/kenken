<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Web Reader</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* === 样式区域 (保持不变) === */
        :root { --primary-color: #07c160; --bg-color: #f7f7f7; }
        body { margin: 0; padding: 0; background-color: var(--bg-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; overflow: hidden; height: 100vh; }
        * { box-sizing: border-box; }
        ::-webkit-scrollbar { display: none; }
        .page-container { height: 100vh; display: flex; flex-direction: column; position: relative; transition: background-color 0.3s; }
        .theme-0 { background-color: #f7f7f7; } .theme-1 { background-color: #f6f1e1; } .theme-2 { background-color: #C7EDCC; } .theme-3 { background-color: #191919; color: #ccc; }
        .video-panel-wrapper { width: 94%; margin: 10px auto; background-color: #000; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.3); position: relative; flex-shrink: 0; z-index: 10; }
        .video-container { width: 100%; position: relative; display: flex; flex-direction: column; }
        .main-media { width: 100%; height: 200px; display: block; object-fit: cover; background: #000; }
        .cover-art-container { width: 100%; height: 200px; position: relative; background: #000; overflow: hidden; }
        .video-subtitle-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 10px; overflow-y: auto; z-index: 20; display: flex; flex-wrap: wrap; align-content: flex-start; }
        .v-note-item { background: rgba(255,255,255,0.85); backdrop-filter: blur(4px); padding: 2px 8px; border-radius: 6px; margin: 0 5px 5px 0; font-size: 13px; display: inline-flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .content-area { flex: 1; overflow-y: auto; padding: 10px 15px 80px 15px; scroll-behavior: smooth; position: relative; }
        .sentence-group { padding: 8px 10px; margin-bottom: 8px; border-radius: 6px; border-left: 4px solid transparent; transition: all 0.2s; }
        .sentence-group.active { background: #f8f3d7; border-left-color: #d4b162; }
        .en-text { font-size: 18px; line-height: 1.4; margin-bottom: 4px; } .cn-text { font-size: 14px; color: #666; line-height: 1.4; }
        .keyword { color: #cc0000; font-weight: bold; cursor: pointer; }
        .player-bar-placeholder { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: #fff; border-top: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .playback-controls { display: flex; align-items: center; gap: 20px; }
        .player-btn { width: 40px; height: 40px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; user-select: none; }
        .play-pause-btn { width: 50px; height: 50px; background: #222; color: #fff; font-size: 24px; }
        .mode-btn { font-size: 12px; width: auto; padding: 0 10px; border-radius: 20px; }
        .popover { position: fixed; background: #2c2c2e; color: #fff; padding: 10px 15px; border-radius: 8px; font-size: 14px; max-width: 80%; z-index: 999; box-shadow: 0 4px 12px rgba(0,0,0,0.3); pointer-events: auto; }
        .settings-popup-wrapper { position: fixed; bottom: 70px; left: 5%; width: 90%; background: #fff; border-radius: 10px; padding: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 200; }
        .settings-scroll { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 5px; }
        .setting-item { text-align: center; flex-shrink: 0; min-width: 50px; cursor: pointer; }
        .loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 2000; font-size: 18px; }
        @media screen and (min-width: 500px) { .page-container { max-width: 800px; margin: 0 auto; background-color: #fff; } }
    </style>
</head>
<body>

<div id="app">
    <div :class="['page-container', 'theme-' + themeIndex]">
        <!-- 页面结构保持不变 -->
        <div class="video-panel-wrapper" v-if="showVideoMode"><!-- ... --></div>
        <div class="content-area" ref="contentArea">
             <div v-for="(item, index) in sentences" :key="index" :id="'sent-' + index"
                 :class="['sentence-group', currentIndex === index ? 'active' : '']">
                <div class="en-text" @click="playSentence(index)"><!-- ... --></div>
                <div class="cn-text">{{ item.cn_text }}</div>
            </div>
        </div>
        <div class="player-bar-placeholder"><!-- ... --></div>
        <div class="loading-mask" v-if="isLoading">加载中...</div>
    </div>
</div>

<script>
    const { createApp, ref, onMounted, onUnmounted, nextTick } = Vue;

    createApp({
        setup() {
            // === 状态变量 (保持不变) ===
            const db = ref(null);
            const audioObj = ref(null);
            const isLoading = ref(true);
            const bookId = ref('');
            const chapterId = ref('');
            const sentences = ref([]);
            const currentIndex = ref(-1);
            let tcbApp = null; // 保存 tcb 实例
            // ... (其他状态变量省略)

            // 1. 动态加载 SDK
            const loadSdkScript = () => new Promise((resolve, reject) => {
                if (window.cloudbase) return resolve(window.cloudbase);
                const script = document.createElement('script');
                script.src = "https://static.cloudbase.net/cloudbase-js-sdk/2.9.1/cloudbase.full.js";
                script.onload = () => resolve(window.cloudbase);
                script.onerror = () => reject(new Error("SDK load failed"));
                document.head.appendChild(script);
            });

            // 2. 初始化
            const initCloud = async () => {
                const params = new URLSearchParams(window.location.search);
                bookId.value = params.get('bookId');
                chapterId.value = params.get('chapterId');
                if (!chapterId.value) return alert('缺少参数');

                if (!localStorage.getItem('web_user')) {
                    alert('请先登录');
                    window.location.href = 'index.html';
                    return;
                }

                audioObj.value = new Audio();
                audioObj.value.addEventListener('ended', onAudioEnded);
                audioObj.value.addEventListener('timeupdate', onAudioTimeUpdate);
                
                try {
                    const cloudbase = await loadSdkScript();
                    tcbApp = cloudbase.init({ env: 'cloud1-4gcnkqkl8e5bcae5', region: 'ap-shanghai' });
                    const auth = tcbApp.auth({ persistence: 'local' });
                    if (!auth.hasLoginState()) await auth.signInAnonymously();
                    db.value = tcbApp.database();
                    
                    // restoreSettings();
                    loadChapter();
                    // startStatTimer();
                } catch (e) {
                    console.error(e);
                    alert('连接失败，请返回首页重试');
                    window.location.href = 'index.html';
                }
            };

            // 3. 核心修改：确保 tcbApp 存在
            const loadChapter = async () => {
                // ✅ 检查 tcbApp 是否已初始化
                if (!tcbApp) {
                    console.error("tcbApp is not initialized yet!");
                    return;
                }

                try {
                    const res = await tcbApp.callFunction({
                        name: 'adminHelper',
                        data: {
                            action: 'getChapter',
                            chapterId: chapterId.value
                        }
                    });

                    if (res.result && res.result.success) {
                        const data = res.result.data;
                        document.title = data.title;
                        sentences.value = data.content;
                        // ... (其他逻辑保持不变)
                        isLoading.value = false;
                    } else {
                        // 如果云函数返回失败（比如无权限），则弹窗提示
                        alert(res.result.msg || '无法加载章节，请确认已授权');
                        isLoading.value = false;
                        // 可以选择跳转回章节页
                        // window.location.href = `chapters.html?bookId=${bookId.value}`;
                    }
                } catch (err) {
                    console.error("Call getChapter failed:", err);
                    alert("加载章节内容失败，请检查网络");
                    isLoading.value = false;
                }
            };

            // === 其他所有函数 (playAt, showNote 等) 保持不变 ===
            const onAudioEnded = () => {};
            const onAudioTimeUpdate = () => {};

            onMounted(() => {
                initCloud();
            });

            onUnmounted(() => {
                // uploadStats();
                if (audioObj.value) audioObj.value.pause();
            });
            
            // 返回所有需要用到的变量和函数
            return {
                isLoading,
                sentences,
                currentIndex,
                themeIndex: ref(0),
                showVideoMode: ref(false),
                // ... (返回所有你在 template 中用到的变量)
            };
        }
    }).mount('#app');
</script>
</body>
</html>
