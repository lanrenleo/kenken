<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Web Reader</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://static.cloudbase.net/cloudbase-js-sdk/2.9.1/cloudbase.full.js"></script>
    
    <style>
        /* === 样式区域 (保持不变) === */
        :root { --primary-color: #07c160; --bg-color: #f7f7f7; }
        body { margin: 0; padding: 0; background-color: var(--bg-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; overflow: hidden; height: 100vh; }
        * { box-sizing: border-box; }
        ::-webkit-scrollbar { display: none; }

        .page-container { height: 100vh; display: flex; flex-direction: column; position: relative; transition: background-color 0.3s; }
        .theme-0 { background-color: #f7f7f7; } .theme-1 { background-color: #f6f1e1; } .theme-2 { background-color: #d7f1da; } .theme-3 { background-color: #191919; color: #ccc; }
        
        .video-panel-wrapper { width: 94%; margin: 10px auto; background-color: #000; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.3); position: relative; flex-shrink: 0; z-index: 10; }
        .main-media { width: 100%; height: 200px; display: block; object-fit: cover; background: #000; }
        
        .content-area { flex: 1; overflow-y: auto; padding: 10px 15px 80px 15px; scroll-behavior: smooth; position: relative; }
        .sentence-group { padding: 8px 10px; margin-bottom: 8px; border-radius: 6px; border-left: 4px solid transparent; transition: all 0.2s; cursor: pointer; }
        .sentence-group.active { background: #f8f3d7; border-left-color: #d4b162; }
        .theme-3 .sentence-group.active { background: #333; border-left-color: #888; }
        
        .en-text { line-height: 1.4; margin-bottom: 4px; } .cn-text { font-size: 14px; color: #666; line-height: 1.4; }
        .theme-3 .cn-text { color: #888; }
        .keyword { color: #cc0000; font-weight: bold; cursor: pointer; }
        
        .player-bar-placeholder { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: #fff; border-top: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .playback-controls { display: flex; align-items: center; gap: 20px; }
        .player-btn { width: 40px; height: 40px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; user-select: none; }
        .play-pause-btn { width: 50px; height: 50px; background: #222; color: #fff; font-size: 24px; }
        
        .mode-btn { font-size: 12px; width: auto; padding: 0 10px; border-radius: 20px; }
        .mode-auto { background: #07c160; color: #fff; } .mode-manual { background: #05a8da; color: #fff; } .mode-silent { background: #333; color: #fff; }
        
        .popover { position: fixed; background: #2c2c2e; color: #fff; padding: 10px 15px; border-radius: 8px; font-size: 14px; max-width: 80%; z-index: 999; box-shadow: 0 4px 12px rgba(0,0,0,0.3); pointer-events: auto; }
        .settings-popup-wrapper { position: fixed; bottom: 70px; left: 5%; width: 90%; background: #fff; border-radius: 10px; padding: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 200; }
        .settings-scroll { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 5px; }
        .setting-item { text-align: center; flex-shrink: 0; min-width: 50px; cursor: pointer; }
        .setting-label { font-size: 12px; color: #999; margin-bottom: 4px; }
        .setting-value { font-size: 14px; font-weight: bold; color: #333; }
        .loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 2000; font-size: 18px; }

        /* 字体大小 */
        .fs-small .en-text { font-size: 17px; } .fs-small .cn-text { font-size: 13px; }
        .fs-normal .en-text { font-size: 19px; } .fs-normal .cn-text { font-size: 14px; }
        .fs-large .en-text { font-size: 21px; } .fs-large .cn-text { font-size: 15px; }
        .fs-xlarge .en-text { font-size: 23px; } .fs-xlarge .cn-text { font-size: 16px; }

        @media screen and (min-width: 500px) { .page-container { max-width: 800px; margin: 0 auto; background-color: #fff; } }
    </style>
</head>
<body>

<div id="app">
    <div :class="['page-container', 'theme-' + themeIndex]" @click="pageClicked">
        
        <div class="video-panel-wrapper" v-if="showVideoMode && (videoUrl || coverUrl)">
            <video v-if="videoUrl" ref="videoPlayer" class="main-media" :src="videoUrl" controls @timeupdate="onVideoTimeUpdate" @ended="onVideoEnded" @play="onVideoPlay" @pause="onVideoPause"></video>
            <div v-else class="main-media" :style="{backgroundImage: 'url('+coverUrl+')', backgroundSize: 'cover'}" @click="togglePlay"></div>
        </div>

        <div :class="['content-area', fontSizes[currentFontSizeIndex].class]" ref="contentArea">
            <div v-for="(item, index) in sentences" :key="index" :id="'sent-' + index"
                 :class="['sentence-group', currentIndex === index ? 'active' : '']">
                <div class="en-text" @click.stop="playSentence(index)">
                    <span v-for="(seg, i) in item.en_segments" :key="i">
                        <span v-if="seg.type === 'keyword'" class="keyword" :style="{color: seg.color}" @click.stop="showNote(seg, $event)">{{ seg.text }}</span>
                        <span v-else>{{ seg.text }}</span>
                    </span>
                </div>
                <div class="cn-text" v-if="displayMode === 0">{{ item.cn_text }}</div>
            </div>
        </div>

        <div class="popover" v-if="showPop" :style="popStyle" @click.stop="addToVocabulary">
            {{ popNote }}
            <div style="font-size:10px; margin-top:4px; opacity:0.7">(点击收藏)</div>
        </div>

        <div class="settings-popup-wrapper" v-if="showSettingsPopup">
            <div class="settings-scroll">
                <div class="setting-item" @click="toggleVideoMode" v-if="videoUrl || coverUrl"><div class="setting-label">视频</div><div class="setting-value">{{ showVideoMode ? '开' : '关' }}</div></div>
                <div class="setting-item" @click="cyclePlaybackRate"><div class="setting-label">倍速</div><div class="setting-value">{{ playbackRates[currentRateIndex] }}x</div></div>
                <div class="setting-item" @click="cyclePlayMode"><div class="setting-label">播放</div><div class="setting-value">{{ playModes[playMode] }}</div></div>
                <div class="setting-item" @click="cycleDisplayMode"><div class="setting-label">显示</div><div class="setting-value">{{ displayModes[displayMode] }}</div></div>
                <div class="setting-item" @click="cycleTheme"><div class="setting-label">主题</div><div class="setting-value">{{ themeNames[themeIndex] }}</div></div>
                <div class="setting-item" @click="cycleFontSize"><div class="setting-label">字号</div><div class="setting-value">{{ fontSizes[currentFontSizeIndex].name }}</div></div>
            </div>
        </div>

        <div class="player-bar-placeholder">
            <div class="player-btn" @click.stop="showSettingsPopup = !showSettingsPopup">☰</div>
            <div class="playback-controls">
                <div class="player-btn" @click.stop="playPrev">ᐊ</div>
                <div class="player-btn play-pause-btn" @click.stop="togglePlay">{{ isPlaying ? '❚❚' : '▶' }}</div>
                <div class="player-btn" @click.stop="playNext">ᐅ</div>
            </div>
            <div :class="['player-btn', 'mode-btn', ...]" @click.stop="toggleReadingMode">{{ ... }}</div>
        </div>
        <div class="loading-mask" v-if="isLoading">加载中...</div>
    </div>
</div>

<script>
    const { createApp, ref, onMounted, onUnmounted, nextTick } = Vue;

    createApp({
        setup() {
            // === 状态变量 ===
            const db = ref(null);
            const audioObj = ref(null);
            const videoPlayer = ref(null);
            const isLoading = ref(true);
            const bookId = ref('');
            const chapterId = ref('');
            const sentences = ref([]);
            const currentIndex = ref(-1);
            const isPlaying = ref(false);
            const audioUrl = ref('');
            const videoUrl = ref('');
            const coverUrl = ref('');
            const themeIndex = ref(0);
            const themeNames = ['默认', '羊皮纸', '绿', '暗黑'];
            const showVideoMode = ref(false);
            const playbackRates = [0.8, 1.0, 1.2, 1.5, 2.0];
            const currentRateIndex = ref(1);
            const playMode = ref(0);
            const playModes = ['顺序', '单句×3', '跟读'];
            const displayMode = ref(0);
            const displayModes = ['双语', '纯英'];
            const fontSizes = [{ name: '小', class: 'fs-small' }, { name: '中', class: 'fs-normal' }, { name: '大', class: 'fs-large' }, { name: '特大', class: 'fs-xlarge' }];
            const currentFontSizeIndex = ref(1);
            const showSettingsPopup = ref(false);
            const readingModeType = ref(1);
            const showPop = ref(false);
            const popNote = ref('');
            const popStyle = ref({});
            let currentNoteData = {};
            let tcbApp = null;
            
            // === 初始化逻辑 ===
            const initCloud = async () => {
                const params = new URLSearchParams(window.location.search);
                bookId.value = params.get('bookId');
                chapterId.value = params.get('chapterId');
                if (!chapterId.value) return alert('缺少参数');
                if (!localStorage.getItem('web_user')) { alert('请先登录'); window.location.href = 'index.html'; return; }

                audioObj.value = new Audio();
                audioObj.value.addEventListener('ended', onAudioEnded);
                audioObj.value.addEventListener('timeupdate', onAudioTimeUpdate);
                
                try {
                    tcbApp = window.cloudbase.init({ env: 'cloud1-4gcnkqkl8e5bcae5', region: 'ap-shanghai' });
                    const auth = tcbApp.auth({ persistence: 'local' });
                    if (!auth.hasLoginState()) await auth.signInAnonymously();
                    db.value = tcbApp.database();
                    loadChapter();
                } catch (e) {
                    console.error(e);
                    window.location.href = 'index.html';
                }
            };

            const loadChapter = async () => {
                try {
                    const res = await tcbApp.callFunction({
                        name: 'adminHelper',
                        data: { action: 'getChapter', chapterId: chapterId.value }
                    });
                    if (res.result && res.result.success) {
                        const data = res.result.data;
                        document.title = data.title;
                        sentences.value = data.content;
                        if (data.audio_url) audioUrl.value = data.audio_url;
                        if (data.video_url) videoUrl.value = data.video_url;
                        if (data.cover_url) coverUrl.value = data.cover_url;
                        const savedIdx = localStorage.getItem(`prog_${bookId.value}_${chapterId.value}`);
                        currentIndex.value = savedIdx ? parseInt(savedIdx) : 0;
                        scrollToCenter(currentIndex.value);
                    } else { alert(res.result.msg || '无法加载'); }
                } catch (err) { console.error("加载章节失败:", err); } 
                finally { isLoading.value = false; }
            };

            // === 播放控制 ===
            const togglePlay = () => {
                if (showVideoMode.value && videoPlayer.value) {
                    videoPlayer.value.paused ? videoPlayer.value.play() : videoPlayer.value.pause();
                } else if (audioObj.value) {
                    if (audioObj.value.paused) {
                        if (!audioObj.value.src) playAt(currentIndex.value >= 0 ? currentIndex.value : 0);
                        else audioObj.value.play();
                    } else { audioObj.value.pause(); }
                }
            };

            const playAt = (index, autoScroll = true) => {
                if (index < 0 || index >= sentences.value.length) return;
                const sent = sentences.value[index];
                currentIndex.value = index;
                if (autoScroll) scrollToCenter(index);
                
                if (showVideoMode.value && videoPlayer.value) {
                    videoPlayer.value.currentTime = sent.start;
                    videoPlayer.value.play();
                } else if (audioUrl.value && audioObj.value) {
                    audioObj.value.src = audioUrl.value;
                    audioObj.value.currentTime = sent.start;
                    audioObj.value.playbackRate = playbackRates[currentRateIndex.value];
                    audioObj.value.play();
                }
                isPlaying.value = true;
                localStorage.setItem(`prog_${bookId.value}_${chapterId.value}`, index);
            };

            const playPrev = () => playAt(currentIndex.value - 1);
            const playNext = () => playAt(currentIndex.value + 1);
            const playSentence = (index) => playAt(index, false);
            
            // === 事件监听 ===
            const onAudioTimeUpdate = () => checkTime(audioObj.value?.currentTime);
            const onVideoTimeUpdate = (e) => checkTime(e.target.currentTime);
            const onAudioEnded = () => { if (playMode.value === 0) playNext(); else isPlaying.value = false; };
            const onVideoEnded = () => isPlaying.value = false;
            const onVideoPlay = () => isPlaying.value = true;
            const onVideoPause = () => isPlaying.value = false;
            
            const checkTime = (time) => {
                if(!time) return;
                const sent = sentences.value[currentIndex.value];
                if (sent && time >= sent.end - 0.2) {
                    if (playMode.value === 1) { // 单句循环
                        if (showVideoMode.value && videoPlayer.value) videoPlayer.value.currentTime = sent.start;
                        else if (audioObj.value) audioObj.value.currentTime = sent.start;
                        return;
                    }
                }
                const nextIdx = sentences.value.findIndex(s => time >= s.start && time < s.end);
                if (nextIdx !== -1 && nextIdx !== currentIndex.value) {
                    currentIndex.value = nextIdx;
                    if (readingModeType.value === 0) scrollToCenter(nextIdx);
                    localStorage.setItem(`prog_${bookId.value}_${chapterId.value}`, nextIdx);
                }
            };

            // === UI 交互 ===
            const scrollToCenter = (index) => {
                nextTick(() => {
                    const el = document.getElementById('sent-' + index);
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
            };

            const showNote = (seg, event) => {
                popNote.value = seg.note;
                currentNoteData = seg;
                showPop.value = true;
                
                const rect = event.target.getBoundingClientRect();
                popStyle.value = {
                    top: `${rect.top - 50}px`,
                    left: `${rect.left}px`,
                };
            };
            
            const addToVocabulary = () => {
                 if (!currentNoteData.text) return;
                 // ... 收藏逻辑 (省略)
                 console.log("收藏:", currentNoteData.text);
                 showPop.value = false;
            };

            const pageClicked = () => {
                showPop.value = false;
                showSettingsPopup.value = false;
            };

            // 设置相关
            const toggleVideoMode = () => { showVideoMode.value = !showVideoMode.value; };
            const cyclePlaybackRate = () => { currentRateIndex.value = (currentRateIndex.value + 1) % playbackRates.length; };
            const cyclePlayMode = () => { playMode.value = (playMode.value + 1) % playModes.length; };
            const cycleDisplayMode = () => { displayMode.value = (displayMode.value + 1) % displayModes.length; };
            const cycleTheme = () => { themeIndex.value = (themeIndex.value + 1) % themeNames.length; };
            const cycleFontSize = () => { currentFontSizeIndex.value = (currentFontSizeIndex.value + 1) % fontSizes.length; };
            const toggleReadingMode = () => { readingModeType.value = (readingModeType.value + 1) % 3; };

            onMounted(() => { initCloud(); });
            onUnmounted(() => { if (audioObj.value) audioObj.value.pause(); });
            
            return {
                isLoading, showVideoMode, videoUrl, coverUrl, sentences, currentIndex, isPlaying,
                themeIndex, themeNames, fontSizes, currentFontSizeIndex, showSettingsPopup,
                playbackRates, currentRateIndex, playMode, playModes, displayMode, displayModes, readingModeType, videoPlayer,
                showPop, popNote, popStyle,
                onVideoTimeUpdate, onVideoEnded, onVideoPlay, onVideoPause,
                playSentence, playPrev, playNext, togglePlay, showNote, addToVocabulary, pageClicked,
                toggleVideoMode, cyclePlaybackRate, cyclePlayMode, cycleDisplayMode, cycleTheme, cycleFontSize, toggleReadingMode
            };
        }
    }).mount('#app');
</script>
</body>
</html>
